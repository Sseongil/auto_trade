<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자동매매 대시보드</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .table-auto {
            width: 100%;
            border-collapse: collapse;
        }
        .table-auto th, .table-auto td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* border-gray-200 */
        }
        .table-auto th {
            background-color: #f8fafc; /* bg-gray-50 */
            font-weight: 600;
            color: #4a5568; /* text-gray-700 */
        }
        .table-auto tbody tr:last-child td {
            border-bottom: none;
        }
        .btn-primary {
            background-color: #4c51bf; /* indigo-700 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #3c429f; /* indigo-800 */
        }
        .btn-danger {
            background-color: #dc2626; /* red-600 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .btn-danger:hover {
            background-color: #b91c1c; /* red-700 */
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4c51bf;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-4xl font-bold text-gray-800 mb-8 text-center">자동매매 시스템 대시보드</h1>

        <!-- Status Section -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">시스템 상태</h2>
            <div id="status-content" class="text-lg text-gray-600">
                <p><strong>서버 시간:</strong> <span id="server-time">로딩 중...</span></p>
                <p><strong>계좌 번호:</strong> <span id="account-number">로딩 중...</span></p>
                <p><strong>예수금:</strong> <span id="balance">로딩 중...</span></p>
                <p><strong>마지막 업데이트:</strong> <span id="last-update">로딩 중...</span></p>
            </div>
            <button id="refresh-status-btn" class="btn-primary mt-4">
                상태 새로고침 <span id="status-loading" class="loading-spinner hidden"></span>
            </button>
        </div>

        <!-- Positions Section -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">현재 보유 종목</h2>
            <div id="positions-content">
                <table class="table-auto">
                    <thead>
                        <tr>
                            <th>종목코드</th>
                            <th>종목명</th>
                            <th>수량</th>
                            <th>매입가</th>
                            <th>현재가</th>
                            <th>수익률 (%)</th>
                            <th>매수일시</th>
                            <th>트레일 하이</th>
                        </tr>
                    </thead>
                    <tbody id="positions-table-body">
                        <tr><td colspan="8" class="text-center py-4">보유 종목 없음 또는 로딩 중...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Trade History Section -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">거래 내역</h2>
            <div class="flex justify-end mb-4">
                <button id="clear-history-btn" class="btn-danger mr-2">
                    거래 내역 삭제 <span id="clear-loading" class="loading-spinner hidden"></span>
                </button>
                <button id="refresh-history-btn" class="btn-primary">
                    거래 내역 새로고침 <span id="history-loading" class="loading-spinner hidden"></span>
                </button>
            </div>
            <div id="trade-history-content">
                <table class="table-auto">
                    <thead>
                        <tr>
                            <th>시간</th>
                            <th>종목명</th>
                            <th>유형</th>
                            <th>수량</th>
                            <th>가격</th>
                            <th>주문번호</th>
                            <th>메시지</th>
                        </tr>
                    </thead>
                    <tbody id="trade-history-table-body">
                        <tr><td colspan="7" class="text-center py-4">거래 내역 없음 또는 로딩 중...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p class="text-xl font-semibold mb-4" id="modal-message">정말 모든 거래 내역을 삭제하시겠습니까?</p>
            <button id="confirmClearBtn" class="btn-danger mr-4">삭제</button>
            <button id="cancelClearBtn" class="btn-primary">취소</button>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000'; // Local Flask server runs on the same origin

        // Elements
        const serverTimeSpan = document.getElementById('server-time');
        const accountNumberSpan = document.getElementById('account-number');
        const balanceSpan = document.getElementById('balance');
        const lastUpdateSpan = document.getElementById('last-update');
        const refreshStatusBtn = document.getElementById('refresh-status-btn');
        const statusLoadingSpinner = document.getElementById('status-loading');

        const positionsTableBody = document.getElementById('positions-table-body');

        const tradeHistoryTableBody = document.getElementById('trade-history-table-body');
        const refreshHistoryBtn = document.getElementById('refresh-history-btn');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const historyLoadingSpinner = document.getElementById('history-loading');
        const clearLoadingSpinner = document.getElementById('clear-loading');

        const confirmModal = document.getElementById('confirmModal');
        const closeButton = document.querySelector('.close-button');
        const confirmClearBtn = document.getElementById('confirmClearBtn');
        const cancelClearBtn = document.getElementById('cancelClearBtn');
        const modalMessage = document.getElementById('modal-message');

        let currentPositions = {}; // To store positions and calculate PnL

        // Helper to format numbers with commas
        function formatNumber(num) {
            return new Intl.NumberFormat('ko-KR').format(num);
        }

        // Fetch Status Data
        async function fetchStatus() {
            statusLoadingSpinner.classList.remove('hidden');
            try {
                const response = await fetch(`${API_BASE_URL}/status`);
                const data = await response.json();

                if (data.status === 'ok') {
                    serverTimeSpan.textContent = data.server_time;
                    accountNumberSpan.textContent = data.account_number;
                    balanceSpan.textContent = `${formatNumber(data.balance)} 원`;
                    lastUpdateSpan.textContent = data.last_kiwoom_update;

                    currentPositions = data.positions; // Store positions
                    renderPositions();
                } else {
                    serverTimeSpan.textContent = '오류';
                    accountNumberSpan.textContent = '오류';
                    balanceSpan.textContent = '오류';
                    lastUpdateSpan.textContent = '오류';
                    positionsTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">${data.message || '상태 정보를 가져오지 못했습니다.'}</td></tr>`;
                    console.error('Failed to fetch status:', data.message);
                }
            } catch (error) {
                console.error('Error fetching status:', error);
                serverTimeSpan.textContent = '연결 오류';
                accountNumberSpan.textContent = '연결 오류';
                balanceSpan.textContent = '연결 오류';
                lastUpdateSpan.textContent = '연결 오류';
                positionsTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">서버 연결 오류.</td></tr>`;
            } finally {
                statusLoadingSpinner.classList.add('hidden');
            }
        }

        // Render Positions
        function renderPositions() {
            positionsTableBody.innerHTML = ''; // Clear existing rows
            if (Object.keys(currentPositions).length === 0) {
                positionsTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4">보유 종목 없음.</td></tr>`;
                return;
            }

            for (const code in currentPositions) {
                const pos = currentPositions[code];
                const row = document.createElement('tr');

                const purchasePrice = parseFloat(pos.purchase_price || 0);
                const currentPrice = parseFloat(pos.current_price || 0); // Assuming real_time_data includes current_price
                let pnlPct = 0;
                if (purchasePrice > 0 && currentPrice > 0) {
                    pnlPct = ((currentPrice - purchasePrice) / purchasePrice) * 100;
                }

                row.innerHTML = `
                    <td class="font-medium">${pos.stock_code || code}</td>
                    <td>${pos.name || '알 수 없음'}</td>
                    <td>${formatNumber(pos.quantity || 0)}</td>
                    <td>${formatNumber(purchasePrice)}원</td>
                    <td>${formatNumber(currentPrice)}원</td>
                    <td class="${pnlPct >= 0 ? 'text-green-600' : 'text-red-600'} font-semibold">${pnlPct.toFixed(2)}%</td>
                    <td>${pos.buy_time || 'N/A'}</td>
                    <td>${formatNumber(pos.trail_high || 0)}원</td>
                `;
                positionsTableBody.appendChild(row);
            }
        }


        // Fetch Trade History
        async function fetchTradeHistory() {
            historyLoadingSpinner.classList.remove('hidden');
            try {
                const response = await fetch(`${API_BASE_URL}/trade_history`);
                const data = await response.json();

                tradeHistoryTableBody.innerHTML = ''; // Clear existing rows
                if (data.trade_history && data.trade_history.length === 0) { // Check data.trade_history
                    tradeHistoryTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4">거래 내역이 없습니다.</td></tr>`;
                } else {
                    data.trade_history.forEach(trade => { // Iterate over data.trade_history
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${trade.timestamp}</td>
                            <td>${trade.stock_name} (${trade.stock_code})</td>
                            <td>${trade.trade_type}</td>
                            <td>${formatNumber(trade.quantity)}</td>
                            <td>${formatNumber(trade.price)}원</td>
                            <td>${trade.order_no}</td>
                            <td>${trade.message}</td>
                        `;
                        tradeHistoryTableBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error fetching trade history:', error);
                tradeHistoryTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">거래 내역을 가져오는 중 오류 발생.</td></tr>`;
            } finally {
                historyLoadingSpinner.classList.add('hidden');
            }
        }

        // Clear Trade History
        async function clearTradeHistory() {
            clearLoadingSpinner.classList.remove('hidden');
            try {
                const response = await fetch(`${API_BASE_URL}/trade_history/clear`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}) // Empty body for POST request
                });
                const data = await response.json();

                if (data.status === 'success') {
                    console.log('Trade history cleared successfully.');
                    fetchTradeHistory(); // Refresh history after clearing
                    modalMessage.textContent = '거래 내역이 성공적으로 삭제되었습니다.';
                    confirmClearBtn.classList.add('hidden');
                    cancelClearBtn.textContent = '확인';
                } else {
                    console.error('Failed to clear trade history:', data.message);
                    modalMessage.textContent = `거래 내역 삭제 실패: ${data.message}`;
                    confirmClearBtn.classList.add('hidden');
                    cancelClearBtn.textContent = '닫기';
                }
            } catch (error) {
                console.error('Error clearing trade history:', error);
                modalMessage.textContent = '거래 내역 삭제 중 오류 발생.';
                confirmClearBtn.classList.add('hidden');
                cancelClearBtn.textContent = '닫기';
            } finally {
                clearLoadingSpinner.classList.add('hidden');
            }
        }

        // Event Listeners
        refreshStatusBtn.addEventListener('click', fetchStatus);
        refreshHistoryBtn.addEventListener('click', fetchTradeHistory);

        clearHistoryBtn.addEventListener('click', () => {
            modalMessage.textContent = '정말 모든 거래 내역을 삭제하시겠습니까?';
            confirmClearBtn.classList.remove('hidden');
            cancelClearBtn.textContent = '취소';
            confirmModal.style.display = 'flex'; // Show modal
        });

        closeButton.addEventListener('click', () => {
            confirmModal.style.display = 'none'; // Hide modal
        });

        cancelClearBtn.addEventListener('click', () => {
            confirmModal.style.display = 'none'; // Hide modal
        });

        confirmClearBtn.addEventListener('click', () => {
            clearTradeHistory();
        });

        // Initial data load
        document.addEventListener('DOMContentLoaded', () => {
            fetchStatus();
            fetchTradeHistory();
            // Refresh data every 30 seconds
            setInterval(fetchStatus, 30000);
            setInterval(fetchTradeHistory, 30000);
        });
    </script>
</body>
</html>
